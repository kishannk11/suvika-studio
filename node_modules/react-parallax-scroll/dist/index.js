"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "Layer", {
  enumerable: true,
  get: function get() {
    return _Layer["default"];
  }
});
Object.defineProperty(exports, "AppearLayer", {
  enumerable: true,
  get: function get() {
    return _AppearLayer["default"];
  }
});
exports["default"] = void 0;

var _react = _interopRequireWildcard(require("react"));

var _context = _interopRequireDefault(require("./Utils/context"));

var _Layer = _interopRequireDefault(require("./Components/Layer"));

var _AppearLayer = _interopRequireDefault(require("./Components/AppearLayer"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; if (obj != null) { var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var Parallax =
/*#__PURE__*/
function (_Component) {
  _inherits(Parallax, _Component);

  function Parallax(props) {
    var _this;

    _classCallCheck(this, Parallax);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(Parallax).call(this, props));

    _defineProperty(_assertThisInitialized(_this), "addLayer", function (layer) {
      _this.layers.push(layer);
    });

    _defineProperty(_assertThisInitialized(_this), "removeLayer", function (layer) {
      _this.layers = _this.layers.filter(function (ly) {
        return ly !== layer;
      });
    });

    _defineProperty(_assertThisInitialized(_this), "addAppearLayer", function (layer) {
      _this.appearLayers.push(layer);
    });

    _defineProperty(_assertThisInitialized(_this), "removeAppearLayer", function (layer) {
      _this.appearLayers = _this.appearLayers(function (ly) {
        return ly !== layer;
      });
    });

    _defineProperty(_assertThisInitialized(_this), "getContext", function () {
      return {
        addLayer: _this.addLayer,
        removeLayer: _this.removeLayer,
        addAppearLayer: _this.addAppearLayer,
        removeAppearLayer: _this.removeAppearLayer
      };
    });

    _defineProperty(_assertThisInitialized(_this), "handleScroll", function () {
      window.requestAnimationFrame(_this.check);
    });

    _defineProperty(_assertThisInitialized(_this), "check", function () {
      _this.checkParallaxItems();

      _this.checkAppearItems();
    });

    _defineProperty(_assertThisInitialized(_this), "isOnScreen", function (layer) {
      var position = layer.ref.current.getBoundingClientRect();
      return position.top < window.innerHeight && position.bottom >= 0;
    });

    _defineProperty(_assertThisInitialized(_this), "checkAppearItems", function () {
      _this.appearLayers.forEach(function (layer) {
        if (_this.isOnScreen(layer)) {
          _this.appear(layer);
        } else {//handle disappear
        }
      });
    });

    _defineProperty(_assertThisInitialized(_this), "checkParallaxItems", function () {
      _this.layers.forEach(function (layer) {
        if (_this.isOnScreen(layer)) {
          _this.draw(layer);
        }
      });
    });

    _defineProperty(_assertThisInitialized(_this), "appear", function (layer) {
      layer.ref.current.style['animation-duration'] = layer.settings.duration;

      if (layer.settings.loop) {
        layer.ref.current.style['animation-iteration-count'] = layer.settings.loop;
      }

      layer.ref.current.classList.add(layer.settings["in"]);
    });

    _defineProperty(_assertThisInitialized(_this), "draw", function (layer) {
      var item = layer.ref.current;
      var position = item.getBoundingClientRect();
      var settings = layer.settings || {
        type: 'backgroundY',
        speed: 0.3
      };
      var speed = settings.speed;
      var newValue = -Math.floor(speed * position.top);
      var min = settings.min || (speed < 0 ? -_this.offset : newValue);
      var max = settings.max || (speed > 0 ? _this.offset : newValue);

      if (newValue < min) {
        newValue = min;
      } else if (newValue > max) {
        newValue = max;
      }

      var updatedValues = {};

      if (Array.isArray(settings.type)) {
        settings.type.forEach(function (t) {
          var _this$getChangedValue = _this.getChangedValue(t, newValue),
              key = _this$getChangedValue.key,
              value = _this$getChangedValue.value;

          if (!updatedValues[key]) {
            updatedValues[key] = [];
          }

          updatedValues[key].push(value);
        });
      } else {
        var _this$getChangedValue2 = _this.getChangedValue(settings.type, newValue),
            key = _this$getChangedValue2.key,
            value = _this$getChangedValue2.value;

        updatedValues[key] = [value];
      } // eslint-disable-next-line


      for (var _key in updatedValues) {
        item.style[_key] = updatedValues[_key].join(' ');
      }
    });

    _defineProperty(_assertThisInitialized(_this), "getChangedValue", function (type, value) {
      switch (type) {
        case 'translateY':
          return {
            key: 'transform',
            value: "translateY(".concat(value, "px)")
          };

        case 'translateX':
          return {
            key: 'transform',
            value: "translateX(".concat(value, "px)")
          };
        // case 'scale':
        //   const scale = value >= 0 ? Math.abs(value / 100) : Math.abs(100 / value);
        //   return {
        //     key: 'transform',
        //     value: `scale(${scale})`
        //   }

        case 'rotate':
          return {
            key: 'transform',
            value: "rotate(".concat(value, "deg)")
          };

        case 'backgroundPositionX':
          return {
            key: 'backgroundPosition',
            value: "".concat(value, "px center")
          };

        default:
          return {
            key: 'backgroundPosition',
            value: "center ".concat(value, "px")
          };
      }
    });

    _this.layers = [];
    _this.appearLayers = [];
    _this.offset = props.offset || 100;
    return _this;
  }

  _createClass(Parallax, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      this.setup();
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      window.removeEventListener('scroll', this.handleScroll);
    }
  }, {
    key: "setup",
    value: function setup() {
      window.addEventListener('scroll', this.handleScroll);
      window.dispatchEvent(new Event('scroll'));
    }
  }, {
    key: "render",
    value: function render() {
      return _react["default"].createElement(_context["default"].Provider, {
        value: this.getContext()
      }, this.props.children);
    }
  }]);

  return Parallax;
}(_react.Component);

exports["default"] = Parallax;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJQYXJhbGxheCIsInByb3BzIiwibGF5ZXIiLCJsYXllcnMiLCJwdXNoIiwiZmlsdGVyIiwibHkiLCJhcHBlYXJMYXllcnMiLCJhZGRMYXllciIsInJlbW92ZUxheWVyIiwiYWRkQXBwZWFyTGF5ZXIiLCJyZW1vdmVBcHBlYXJMYXllciIsIndpbmRvdyIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImNoZWNrIiwiY2hlY2tQYXJhbGxheEl0ZW1zIiwiY2hlY2tBcHBlYXJJdGVtcyIsInBvc2l0aW9uIiwicmVmIiwiY3VycmVudCIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsInRvcCIsImlubmVySGVpZ2h0IiwiYm90dG9tIiwiZm9yRWFjaCIsImlzT25TY3JlZW4iLCJhcHBlYXIiLCJkcmF3Iiwic3R5bGUiLCJzZXR0aW5ncyIsImR1cmF0aW9uIiwibG9vcCIsImNsYXNzTGlzdCIsImFkZCIsIml0ZW0iLCJ0eXBlIiwic3BlZWQiLCJuZXdWYWx1ZSIsIk1hdGgiLCJmbG9vciIsIm1pbiIsIm9mZnNldCIsIm1heCIsInVwZGF0ZWRWYWx1ZXMiLCJBcnJheSIsImlzQXJyYXkiLCJ0IiwiZ2V0Q2hhbmdlZFZhbHVlIiwia2V5IiwidmFsdWUiLCJqb2luIiwic2V0dXAiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiaGFuZGxlU2Nyb2xsIiwiYWRkRXZlbnRMaXN0ZW5lciIsImRpc3BhdGNoRXZlbnQiLCJFdmVudCIsImdldENvbnRleHQiLCJjaGlsZHJlbiIsIkNvbXBvbmVudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBT3FCQSxROzs7OztBQUNuQixvQkFBWUMsS0FBWixFQUFtQjtBQUFBOztBQUFBOztBQUNqQixrRkFBTUEsS0FBTjs7QUFEaUIsK0RBUVIsVUFBQ0MsS0FBRCxFQUFXO0FBQ3BCLFlBQUtD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aUJBQU87QUFDTEQsWUFBQUEsR0FBRyxFQUFFLG9CQURBO0FBRUxDLFlBQUFBLEtBQUssWUFBS0EsS0FBTDtBQUZBLFdBQVA7O0FBS0Y7QUFDRSxpQkFBTztBQUNMRCxZQUFBQSxHQUFHLEVBQUUsb0JBREE7QUFFTEMsWUFBQUEsS0FBSyxtQkFBWUEsS0FBWjtBQUZBLFdBQVA7QUFqQ0o7QUFzQ0QsS0FuS2tCOztBQUdqQixVQUFLOUMsTUFBTCxHQUFjLEVBQWQ7QUFDQSxVQUFLSSxZQUFMLEdBQW9CLEVBQXBCO0FBQ0EsVUFBS2tDLE1BQUwsR0FBY3hDLEtBQUssQ0FBQ3dDLE1BQU4sSUFBZ0IsR0FBOUI7QUFMaUI7QUFNbEI7Ozs7d0NBMkJtQjtBQUNsQixXQUFLVSxLQUFMO0FBQ0Q7OzsyQ0FFc0I7QUFDckJ2QyxNQUFBQSxNQUFNLENBQUN3QyxtQkFBUCxDQUEyQixRQUEzQixFQUFxQyxLQUFLQyxZQUExQztBQUNEOzs7NEJBRU87QUFDTnpDLE1BQUFBLE1BQU0sQ0FBQzBDLGdCQUFQLENBQXdCLFFBQXhCLEVBQWtDLEtBQUtELFlBQXZDO0FBQ0F6QyxNQUFBQSxNQUFNLENBQUMyQyxhQUFQLENBQXFCLElBQUlDLEtBQUosQ0FBVSxRQUFWLENBQXJCO0FBQ0Q7Ozs2QkF5SFE7QUFDUCxhQUNFLGdDQUFDLG1CQUFELENBQVMsUUFBVDtBQUFrQixRQUFBLEtBQUssRUFBRSxLQUFLQyxVQUFMO0FBQXpCLFNBQ0csS0FBS3hELEtBQUwsQ0FBV3lELFFBRGQsQ0FERjtBQUtEOzs7O0VBNUttQ0MsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IENvbnRleHQgZnJvbSAnLi9VdGlscy9jb250ZXh0JztcbmltcG9ydCBMYXllciBmcm9tICcuL0NvbXBvbmVudHMvTGF5ZXInO1xuaW1wb3J0IEFwcGVhckxheWVyIGZyb20gJy4vQ29tcG9uZW50cy9BcHBlYXJMYXllcic7XG5cbmV4cG9ydCB7XG4gIExheWVyLFxuICBBcHBlYXJMYXllclxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQYXJhbGxheCBleHRlbmRzIENvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgdGhpcy5sYXllcnMgPSBbXTtcbiAgICB0aGlzLmFwcGVhckxheWVycyA9IFtdO1xuICAgIHRoaXMub2Zmc2V0ID0gcHJvcHMub2Zmc2V0IHx8IDEwMDtcbiAgfVxuXG4gIGFkZExheWVyID0gKGxheWVyKSA9PiB7XG4gICAgdGhpcy5sYXllcnMucHVzaChsYXllcik7XG4gIH1cblxuICByZW1vdmVMYXllciA9IChsYXllcikgPT4ge1xuICAgIHRoaXMubGF5ZXJzID0gdGhpcy5sYXllcnMuZmlsdGVyKGx5ID0+IGx5ICE9PSBsYXllcik7XG4gIH1cblxuICBhZGRBcHBlYXJMYXllciA9IChsYXllcikgPT4ge1xuICAgIHRoaXMuYXBwZWFyTGF5ZXJzLnB1c2gobGF5ZXIpO1xuICB9XG5cbiAgcmVtb3ZlQXBwZWFyTGF5ZXIgPSAobGF5ZXIpID0+IHtcbiAgICB0aGlzLmFwcGVhckxheWVycyA9IHRoaXMuYXBwZWFyTGF5ZXJzKGx5ID0+IGx5ICE9PSBsYXllcik7XG4gIH1cblxuICBnZXRDb250ZXh0ID0gKCkgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICBhZGRMYXllcjogdGhpcy5hZGRMYXllcixcbiAgICAgIHJlbW92ZUxheWVyOiB0aGlzLnJlbW92ZUxheWVyLFxuICAgICAgYWRkQXBwZWFyTGF5ZXI6IHRoaXMuYWRkQXBwZWFyTGF5ZXIsXG4gICAgICByZW1vdmVBcHBlYXJMYXllcjogdGhpcy5yZW1vdmVBcHBlYXJMYXllclxuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIHRoaXMuc2V0dXAoKTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLmhhbmRsZVNjcm9sbCk7XG4gIH1cblxuICBzZXR1cCgpIHtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5oYW5kbGVTY3JvbGwpO1xuICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudCgnc2Nyb2xsJykpO1xuICB9XG5cbiAgaGFuZGxlU2Nyb2xsID0gKCkgPT4ge1xuICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5jaGVjaylcbiAgfVxuXG4gIGNoZWNrID0gKCkgPT4ge1xuICAgIHRoaXMuY2hlY2tQYXJhbGxheEl0ZW1zKCk7XG4gICAgdGhpcy5jaGVja0FwcGVhckl0ZW1zKCk7XG4gIH1cblxuICBpc09uU2NyZWVuID0gKGxheWVyKSA9PiB7XG4gICAgY29uc3QgcG9zaXRpb24gPSBsYXllci5yZWYuY3VycmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICByZXR1cm4gcG9zaXRpb24udG9wIDwgd2luZG93LmlubmVySGVpZ2h0ICYmIHBvc2l0aW9uLmJvdHRvbSA+PSAwO1xuICB9XG5cbiAgY2hlY2tBcHBlYXJJdGVtcyA9ICgpID0+IHtcbiAgICB0aGlzLmFwcGVhckxheWVycy5mb3JFYWNoKGxheWVyID0+IHtcbiAgICAgIGlmICh0aGlzLmlzT25TY3JlZW4obGF5ZXIpKSB7XG4gICAgICAgIHRoaXMuYXBwZWFyKGxheWVyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vaGFuZGxlIGRpc2FwcGVhclxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgY2hlY2tQYXJhbGxheEl0ZW1zID0gKCkgPT4ge1xuICAgIHRoaXMubGF5ZXJzLmZvckVhY2gobGF5ZXIgPT4ge1xuICAgICAgaWYgKHRoaXMuaXNPblNjcmVlbihsYXllcikpIHtcbiAgICAgICAgdGhpcy5kcmF3KGxheWVyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFwcGVhciA9IChsYXllcikgPT4ge1xuICAgIGxheWVyLnJlZi5jdXJyZW50LnN0eWxlWydhbmltYXRpb24tZHVyYXRpb24nXSA9IGxheWVyLnNldHRpbmdzLmR1cmF0aW9uO1xuICAgIGlmIChsYXllci5zZXR0aW5ncy5sb29wKSB7XG4gICAgICBsYXllci5yZWYuY3VycmVudC5zdHlsZVsnYW5pbWF0aW9uLWl0ZXJhdGlvbi1jb3VudCddID0gbGF5ZXIuc2V0dGluZ3MubG9vcDtcbiAgICB9XG5cbiAgICBsYXllci5yZWYuY3VycmVudC5jbGFzc0xpc3QuYWRkKGxheWVyLnNldHRpbmdzLmluKTtcbiAgfVxuXG4gIGRyYXcgPSAobGF5ZXIpID0+IHtcbiAgICBjb25zdCBpdGVtID0gbGF5ZXIucmVmLmN1cnJlbnQ7XG4gICAgY29uc3QgcG9zaXRpb24gPSBpdGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGNvbnN0IHNldHRpbmdzID0gbGF5ZXIuc2V0dGluZ3MgfHwgeyB0eXBlOiAnYmFja2dyb3VuZFknLCBzcGVlZDogMC4zIH07XG5cbiAgICBjb25zdCBzcGVlZCA9IHNldHRpbmdzLnNwZWVkO1xuICAgIGxldCBuZXdWYWx1ZSA9IC1NYXRoLmZsb29yKHNwZWVkICogcG9zaXRpb24udG9wKTtcblxuICAgIGNvbnN0IG1pbiA9IHNldHRpbmdzLm1pbiB8fCAoc3BlZWQgPCAwID8gLXRoaXMub2Zmc2V0IDogbmV3VmFsdWUpO1xuICAgIGNvbnN0IG1heCA9IHNldHRpbmdzLm1heCB8fCAoc3BlZWQgPiAwID8gdGhpcy5vZmZzZXQgOiBuZXdWYWx1ZSk7XG5cbiAgICBpZiAobmV3VmFsdWUgPCBtaW4pIHtcbiAgICAgIG5ld1ZhbHVlID0gbWluO1xuICAgIH0gZWxzZSBpZiAobmV3VmFsdWUgPiBtYXgpIHtcbiAgICAgIG5ld1ZhbHVlID0gbWF4O1xuICAgIH1cblxuICAgIGNvbnN0IHVwZGF0ZWRWYWx1ZXMgPSB7fTtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShzZXR0aW5ncy50eXBlKSkge1xuICAgICAgc2V0dGluZ3MudHlwZS5mb3JFYWNoKHQgPT4ge1xuICAgICAgICBjb25zdCB7IGtleSwgdmFsdWUgfSA9IHRoaXMuZ2V0Q2hhbmdlZFZhbHVlKHQsIG5ld1ZhbHVlKTtcbiAgICAgICAgaWYgKCF1cGRhdGVkVmFsdWVzW2tleV0pIHtcbiAgICAgICAgICB1cGRhdGVkVmFsdWVzW2tleV0gPSBbXTtcbiAgICAgICAgfVxuICAgICAgICB1cGRhdGVkVmFsdWVzW2tleV0ucHVzaCh2YWx1ZSk7XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB7IGtleSwgdmFsdWUgfSA9IHRoaXMuZ2V0Q2hhbmdlZFZhbHVlKHNldHRpbmdzLnR5cGUsIG5ld1ZhbHVlKTtcbiAgICAgIHVwZGF0ZWRWYWx1ZXNba2V5XSA9IFt2YWx1ZV07XG4gICAgfVxuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lXG4gICAgZm9yIChsZXQga2V5IGluIHVwZGF0ZWRWYWx1ZXMpIHtcbiAgICAgIGl0ZW0uc3R5bGVba2V5XSA9IHVwZGF0ZWRWYWx1ZXNba2V5XS5qb2luKCcgJyk7XG4gICAgfVxuICB9XG5cbiAgZ2V0Q2hhbmdlZFZhbHVlID0gKHR5cGUsIHZhbHVlKSA9PiB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlICd0cmFuc2xhdGVZJzpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBrZXk6ICd0cmFuc2Zvcm0nLFxuICAgICAgICAgIHZhbHVlOiBgdHJhbnNsYXRlWSgke3ZhbHVlfXB4KWBcbiAgICAgICAgfTtcblxuICAgICAgY2FzZSAndHJhbnNsYXRlWCc6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAga2V5OiAndHJhbnNmb3JtJyxcbiAgICAgICAgICB2YWx1ZTogYHRyYW5zbGF0ZVgoJHt2YWx1ZX1weClgXG4gICAgICAgIH1cblxuICAgICAgLy8gY2FzZSAnc2NhbGUnOlxuICAgICAgLy8gICBjb25zdCBzY2FsZSA9IHZhbHVlID49IDAgPyBNYXRoLmFicyh2YWx1ZSAvIDEwMCkgOiBNYXRoLmFicygxMDAgLyB2YWx1ZSk7XG4gICAgICAvLyAgIHJldHVybiB7XG4gICAgICAvLyAgICAga2V5OiAndHJhbnNmb3JtJyxcbiAgICAgIC8vICAgICB2YWx1ZTogYHNjYWxlKCR7c2NhbGV9KWBcbiAgICAgIC8vICAgfVxuXG4gICAgICBjYXNlICdyb3RhdGUnOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGtleTogJ3RyYW5zZm9ybScsXG4gICAgICAgICAgdmFsdWU6IGByb3RhdGUoJHt2YWx1ZX1kZWcpYFxuICAgICAgICB9XG5cbiAgICAgIGNhc2UgJ2JhY2tncm91bmRQb3NpdGlvblgnOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGtleTogJ2JhY2tncm91bmRQb3NpdGlvbicsXG4gICAgICAgICAgdmFsdWU6IGAke3ZhbHVlfXB4IGNlbnRlcmBcbiAgICAgICAgfTtcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBrZXk6ICdiYWNrZ3JvdW5kUG9zaXRpb24nLFxuICAgICAgICAgIHZhbHVlOiBgY2VudGVyICR7dmFsdWV9cHhgXG4gICAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIHJldHVybiAoXG4gICAgICA8Q29udGV4dC5Qcm92aWRlciB2YWx1ZT17dGhpcy5nZXRDb250ZXh0KCl9PlxuICAgICAgICB7dGhpcy5wcm9wcy5jaGlsZHJlbn1cbiAgICAgIDwvQ29udGV4dC5Qcm92aWRlcj5cbiAgICApXG4gIH1cbn0iXX0=